name: 'Terraform CD for Infra Repo'

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

permissions:
  contents: read
  id-token: write   # OIDC í† í° ìš”ì²­ì— í•„ìˆ˜
  pull-requests: write # PR ì½”ë©˜íŠ¸ì— plan ê²°ê³¼ ì‘ì„± ì‹œ í•„ìš”

jobs:
  terraform-plan:
    name: 'Terraform Plan'
    # main ë¸Œëœì¹˜ë¡œì˜ pushê°€ ì•„ë‹ˆê³ , develop ë¸Œëœì¹˜ë¡œì˜ push ë˜ëŠ” PRì¼ ë•Œ ì‹¤í–‰
    if: github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref_name == 'develop')
    runs-on: ubuntu-latest
    environment: develop # ë˜ëŠ” staging (GitHub í™˜ê²½ ì„¤ì •ì— ë”°ë¼)

    env:
      # GCP WIF ì„¤ì •ê°’ (GitHub Secretsì—ì„œ ê°€ì ¸ì˜¤ëŠ” ê²ƒì„ ê°•ë ¥íˆ ê¶Œì¥)
      GCP_PROJECT_NUMBER: ${{ secrets.GCP_DEV_PROJECT_NUMBER }} # ê°œë°œ/ìŠ¤í…Œì´ì§• í™˜ê²½ í”„ë¡œì íŠ¸ ë²ˆí˜¸
      GCP_WORKLOAD_IDENTITY_POOL_ID: ${{ secrets.GCP_WORKLOAD_IDENTITY_POOL_ID }} # ë™ì¼í•œ í’€ ì‚¬ìš© ê°€ëŠ¥
      GCP_WORKLOAD_IDENTITY_PROVIDER_ID: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER_ID }} # ë™ì¼í•œ ê³µê¸‰ì ì‚¬ìš© ê°€ëŠ¥
      # GCP_SERVICE_ACCOUNT_EMAIL: ${{ secrets.GCP_DEV_SERVICE_ACCOUNT_EMAIL }} # ê°œë°œ/ìŠ¤í…Œì´ì§• í™˜ê²½ìš© ì„œë¹„ìŠ¤ ê³„ì •
      # TF_VAR_k3s_token_dev: ${{ secrets.K3S_TOKEN_DEV }} # ê°œë°œ í™˜ê²½ìš© í† í° (í•„ìš”ì‹œ)

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: 'Authenticate to Google Cloud (Dev/Staging)'
      id: auth_dev
      uses: 'google-github-actions/auth@v2'
      with:
        workload_identity_provider: 'projects/${{ env.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ env.GCP_WORKLOAD_IDENTITY_POOL_ID }}/providers/${{ env.GCP_WORKLOAD_IDENTITY_PROVIDER_ID }}'
        service_account: '${{ env.GCP_SERVICE_ACCOUNT_EMAIL }}'

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Terraform Init (Dev/Staging)
      run: terraform init
      working-directory: ./dmInfra/environments/dev # ë˜ëŠ” staging í™˜ê²½ ê²½ë¡œ

    - name: Terraform Validate
      run: terraform validate
      working-directory: ./dmInfra/environments/dev

    - name: Terraform Plan (Dev/Staging)
      id: plan_dev
      run: |
        terraform plan \
          -var-file="terraform.tfvars" \
          -input=false \
          -no-color \
          -out=tfplan \
          > plan.txt
      working-directory: ./dmInfra/environments/dev
      continue-on-error: true # Planì— ì‹¤íŒ¨í•´ë„ ë‹¤ìŒ ë‹¨ê³„ (ì½”ë©˜íŠ¸) ì‹¤í–‰

    # PRì— Plan ê²°ê³¼ ì½”ë©˜íŠ¸ (ì„ íƒ ì‚¬í•­)
    - name: Comment PR with Terraform Plan
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          const planOutput = fs.readFileSync('./dmInfra/environments/dev/plan.txt', 'utf8');
          const truncatedPlan = planOutput.substring(0, 65000); // ì½”ë©˜íŠ¸ ê¸¸ì´ ì œí•œ ê³ ë ¤
          const output = `#### Terraform Plan for Dev/Staging Environment ğŸ“–
          <details><summary>Show Plan</summary>

          \`\`\`terraform
          ${truncatedPlan}
          \`\`\`
          </details>
          *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          });

    - name: Upload Terraform Plan Artifact (Dev/Staging)
      uses: actions/upload-artifact@v4
      with:
        name: tfplan-dev
        path: ./dmInfra/environments/dev/tfplan

    - name: Terraform Plan Exit Code
      run: exit ${{ steps.plan_dev.outcome == 'failure' && 1 || 0 }}


  terraform-apply-prod:
    name: 'Terraform Apply to Production'
    # main ë¸Œëœì¹˜ë¡œì˜ pushì¼ ë•Œë§Œ ì‹¤í–‰ (PRì´ ì•„ë‹˜)
    if: github.event_name == 'push' && github.ref_name == 'main'
    runs-on: ubuntu-latest
    environment: production # GitHub í™˜ê²½ ì„¤ì • ì‚¬ìš© (ìŠ¹ì¸ì, Secrets ë“± ê´€ë¦¬)
    needs: [terraform-plan] # main ë¸Œëœì¹˜ë¡œì˜ push ì‹œì—ë„ planì„ ë¨¼ì € ì‹¤í–‰í•˜ë„ë¡ ìœ ë„í•˜ê±°ë‚˜, ë³„ë„ plan ì¡ ì •ì˜

    env:
      # GCP WIF ì„¤ì •ê°’ (GitHub Secretsì—ì„œ ê°€ì ¸ì˜¤ëŠ” ê²ƒì„ ê°•ë ¥íˆ ê¶Œì¥)
      GCP_PROJECT_NUMBER: ${{ secrets.GCP_PROD_PROJECT_NUMBER }} # ìš´ì˜ í™˜ê²½ í”„ë¡œì íŠ¸ ë²ˆí˜¸
      GCP_WORKLOAD_IDENTITY_POOL_ID: ${{ secrets.GCP_WORKLOAD_IDENTITY_POOL_ID }}
      GCP_WORKLOAD_IDENTITY_PROVIDER_ID: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER_ID }}
      # GCP_SERVICE_ACCOUNT_EMAIL: ${{ secrets.GCP_PROD_SERVICE_ACCOUNT_EMAIL }} # ìš´ì˜ í™˜ê²½ìš© ì„œë¹„ìŠ¤ ê³„ì •
      # TF_VAR_k3s_token_prod: ${{ secrets.K3S_TOKEN_PROD }} # ìš´ì˜ í™˜ê²½ìš© í† í°
      TF_VAR_k3s_url_prod: ${{ secrets.K3S_PROD_URL }} # terraform.tfvars ëŒ€ì‹  Secrets ì‚¬ìš© ì‹œ
      TF_VAR_k3s_token_prod: ${{ secrets.K3S_PROD_TOKEN }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: 'Authenticate to Google Cloud (Production)'
      id: auth_prod
      uses: 'google-github-actions/auth@v2'
      with:
        workload_identity_provider: 'projects/${{ env.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ env.GCP_WORKLOAD_IDENTITY_POOL_ID }}/providers/${{ env.GCP_WORKLOAD_IDENTITY_PROVIDER_ID }}'
        # service_account: '${{ env.GCP_SERVICE_ACCOUNT_EMAIL }}'

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    - name: Terraform Init (Production)
      run: terraform init
      working-directory: ./dmInfra/environments/prod

    # ìš´ì˜ í™˜ê²½ Apply ì „ Plan ë‹¨ê³„ (í•„ìˆ˜)
    - name: Terraform Plan (Production)
      run: |
        terraform plan \
          -var-file="terraform.tfvars" \
          -input=false \
          -out=tfplan-prod
      working-directory: ./dmInfra/environments/prod

    # # (ê°•ë ¥ ê¶Œì¥) ìš´ì˜ í™˜ê²½ Apply ì „ ìˆ˜ë™ ìŠ¹ì¸ ë‹¨ê³„
    # - name: Manual Approval for Production Deployment
    #   uses: trstringer/manual-approval@v1
    #   with:
    #     secret: ${{ github.TOKEN }} # ë˜ëŠ” PAT (Personal Access Token)
    #     approvers: 'your-github-username, another-approver' # ìŠ¹ì¸ì GitHub ìœ ì €ë„¤ì„
    #     minimum-approvals: 1 # ìµœì†Œ ìŠ¹ì¸ì ìˆ˜
    #     issue-title: "PROD Deployment: Terraform Apply Approval Required for main branch"
    #     issue-body: "Review the Terraform plan for production (see run artifacts) and approve/reject."
    #     # notify-users: 'user-to-notify' # ì•Œë¦¼ ë°›ì„ ì‚¬ìš©ì (ì„ íƒ)

    - name: Terraform Apply (Production)
      run: terraform apply -input=false tfplan-prod
      working-directory: ./dmInfra/environments/prod
