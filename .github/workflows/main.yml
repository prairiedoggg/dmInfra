name: 'Terraform CD for Infra Repo'

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš©

permissions:
  contents: read
  id-token: write   # OIDC í† í° ìš”ì²­ì— í•„ìˆ˜
  pull-requests: write # PR ì½”ë©˜íŠ¸ì— plan ê²°ê³¼ ì‘ì„± ì‹œ í•„ìš”

jobs:
  terraform-plan-dev: # ì‘ì—… ì´ë¦„ ëª…í™•í™” (develop í™˜ê²½ìš© plan)
    name: 'Terraform Plan (Dev/Staging)'
    # develop ë¸Œëœì¹˜ë¡œì˜ push ë˜ëŠ” main/develop ëŒ€ìƒ PRì¼ ë•Œ ì‹¤í–‰
    if: (github.event_name == 'push' && github.ref_name == 'develop') || (github.event_name == 'pull_request' && (github.base_ref == 'main' || github.base_ref == 'develop'))
    runs-on: ubuntu-latest
    environment: develop

    env:
      GCP_PROJECT_NUMBER: ${{ secrets.GCP_DEV_PROJECT_NUMBER }}
      GCP_WORKLOAD_IDENTITY_POOL_ID: ${{ secrets.GCP_WORKLOAD_IDENTITY_POOL_ID }}
      GCP_WORKLOAD_IDENTITY_PROVIDER_ID: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER_ID }}
      GCP_SERVICE_ACCOUNT_EMAIL: ${{ secrets.GCP_DEV_SERVICE_ACCOUNT_EMAIL }} # ìˆ˜ì •: ì£¼ì„ í•´ì œ ë° ì˜¬ë°”ë¥¸ Secret ì‚¬ìš©
      # TF_LOG: "DEBUG" # í•„ìš”ì‹œ ì£¼ì„ í•´ì œ

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: 'Debug: Print Environment Variables'
      run: |
        echo "Workflow triggered by: ${{ github.event_name }}, ref: ${{ github.ref_name }}, base_ref: ${{ github.base_ref }}"
        echo "GCP_PROJECT_NUMBER is set: ${{ env.GCP_PROJECT_NUMBER != '' }}"
        echo "GCP_SERVICE_ACCOUNT_EMAIL is set: ${{ env.GCP_SERVICE_ACCOUNT_EMAIL != '' }}"

    - name: 'Authenticate to Google Cloud (Dev/Staging)'
      id: auth_dev
      uses: 'google-github-actions/auth@v2'
      with:
        workload_identity_provider: 'projects/${{ env.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ env.GCP_WORKLOAD_IDENTITY_POOL_ID }}/providers/${{ env.GCP_WORKLOAD_IDENTITY_PROVIDER_ID }}'
        service_account: '${{ env.GCP_SERVICE_ACCOUNT_EMAIL }}'

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    - name: 'Debug: Show files in dev environment directory'
      run: |
        pwd
        ls -la ./environments/dev
      working-directory: .

    - name: Terraform Init (Dev/Staging)
      run: terraform init
      working-directory: ./environments/dev # ìˆ˜ì •: ./dmInfra/ ì œê±°

    - name: Terraform Validate (Dev/Staging)
      run: terraform validate
      working-directory: ./environments/dev # ìˆ˜ì •: ./dmInfra/ ì œê±°

    - name: Terraform Plan (Dev/Staging)
      id: plan_dev
      run: |
        terraform plan \
          -var-file="terraform.tfvars" \
          -input=false \
          -no-color \
          -out=tfplan \
          > plan.txt
      working-directory: ./environments/dev # ìˆ˜ì •: ./dmInfra/ ì œê±°
      continue-on-error: true

    - name: Comment PR with Terraform Plan
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          let planOutput = 'No plan output captured.';
          try {
            planOutput = fs.readFileSync('./environments/dev/plan.txt', 'utf8'); // ìˆ˜ì •: ./dmInfra/ ì œê±°
          } catch (e) {
            console.error('Error reading plan.txt:', e);
            planOutput = 'Error reading plan.txt. See action logs for details.';
          }
          const truncatedPlan = planOutput.substring(0, 65000);
          const output = `#### Terraform Plan for Dev/Staging Environment ğŸ“–
          <details><summary>Show Plan</summary>
          \`\`\`terraform
          ${truncatedPlan}
          \`\`\`
          </details>
          *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Ref: \`${{ github.ref }}\`*`;
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          });

    - name: Upload Terraform Plan Artifact (Dev/Staging)
      if: steps.plan_dev.outcome == 'success' # Plan ì„±ê³µ ì‹œì—ë§Œ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: tfplan-dev
        path: ./environments/dev/tfplan # ìˆ˜ì •: ./dmInfra/ ì œê±°

    - name: Terraform Plan Exit Code
      run: exit ${{ steps.plan_dev.outcome == 'failure' && 1 || 0 }}

  terraform-apply-prod:
    name: 'Terraform Apply to Production'
    if: github.event_name == 'push' && github.ref_name == 'main'
    runs-on: ubuntu-latest
    environment: production
    # needs: [terraform-plan-dev] # Main ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œ dev planì— ì˜ì¡´í•  í•„ìš” ì—†ìŒ. prod ìì²´ plan/apply ìˆ˜í–‰

    env:
      GCP_PROJECT_NUMBER: ${{ secrets.GCP_PROD_PROJECT_NUMBER }}
      GCP_WORKLOAD_IDENTITY_POOL_ID: ${{ secrets.GCP_WORKLOAD_IDENTITY_POOL_ID }}
      GCP_WORKLOAD_IDENTITY_PROVIDER_ID: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER_ID }}
      GCP_SERVICE_ACCOUNT_EMAIL: ${{ secrets.GCP_PROD_SERVICE_ACCOUNT_EMAIL }} # ìˆ˜ì •: ì£¼ì„ í•´ì œ ë° ì˜¬ë°”ë¥¸ Secret ì‚¬ìš©
      TF_VAR_k3s_url_prod: ${{ secrets.K3S_PROD_URL }}
      TF_VAR_k3s_token_prod: ${{ secrets.K3S_PROD_TOKEN }}
      # TF_LOG: "DEBUG" # í•„ìš”ì‹œ ì£¼ì„ í•´ì œ

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: 'Debug: Print Environment Variables for Prod'
      run: |
        echo "Workflow triggered by: ${{ github.event_name }}, ref: ${{ github.ref_name }}"
        echo "GCP_PROD_PROJECT_NUMBER is set: ${{ env.GCP_PROJECT_NUMBER != '' }}"
        echo "GCP_PROD_SERVICE_ACCOUNT_EMAIL is set: ${{ env.GCP_SERVICE_ACCOUNT_EMAIL != '' }}"

    - name: 'Authenticate to Google Cloud (Production)'
      id: auth_prod
      uses: 'google-github-actions/auth@v2'
      with:
        workload_identity_provider: 'projects/${{ env.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ env.GCP_WORKLOAD_IDENTITY_POOL_ID }}/providers/${{ env.GCP_WORKLOAD_IDENTITY_PROVIDER_ID }}'
        service_account: '${{ env.GCP_SERVICE_ACCOUNT_EMAIL }}' # ìˆ˜ì •: ì£¼ì„ í•´ì œ

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    - name: 'Debug: Show files in prod environment directory'
      run: |
        pwd
        ls -la ./environments/prod
      working-directory: .

    - name: Terraform Init (Production)
      run: terraform init
      working-directory: ./environments/prod # ìˆ˜ì •: ./dmInfra/ ì œê±°

    - name: Terraform Plan (Production) # Apply ì „ í•­ìƒ Plan ì‹¤í–‰
      id: plan_prod
      run: |
        terraform plan \
          -var-file="terraform.tfvars" \
          -input=false \
          -out=tfplan-prod
      working-directory: ./environments/prod # ìˆ˜ì •: ./dmInfra/ ì œê±°

    # Manual Approval (ì´ ë¶€ë¶„ì€ ê·¸ëŒ€ë¡œ ë‘ê² ìŠµë‹ˆë‹¤. í•„ìš”í•˜ì‹œë©´ ì£¼ì„ í•´ì œí•˜ê³  ì„¤ì •í•˜ì„¸ìš”)
    # - name: Manual Approval for Production Deployment
    #   uses: trstringer/manual-approval@v1
    #   with:
    #     secret: ${{ github.TOKEN }}
    #     approvers: 'your-github-username'
    #     minimum-approvals: 1
    #     issue-title: "PROD Deployment: Terraform Apply Approval Required for main branch"
    #     issue-body: "Review the Terraform plan for production (see run artifacts or output of 'Terraform Plan (Production)' step) and approve/reject."

    - name: Terraform Apply (Production)
      if: steps.plan_prod.outcome == 'success' # Plan ì„±ê³µ ì‹œì—ë§Œ Apply
      run: terraform apply -input=false tfplan-prod
      working-directory: ./environments/prod # ìˆ˜ì •: ./dmInfra/ ì œê±°
